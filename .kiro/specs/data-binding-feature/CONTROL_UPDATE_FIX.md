# ç»„ä»¶å±æ€§æ›´æ–°ä¸ç”Ÿæ•ˆé—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

æ ¹æ®ç”¨æˆ·åé¦ˆå’Œæˆªå›¾:

1. **åœ¨å¼¹æ€§å¸ƒå±€ä¸­æ·»åŠ è¡¨æ ¼ç»„ä»¶ä½œä¸ºå­ç»„ä»¶æ—¶,ä¿®æ”¹è¡¨æ ¼ç»„ä»¶çš„é«˜åº¦ä»¥åŠå®½åº¦ä¸ç”Ÿæ•ˆ**
2. **å•ä¸ªç»„ä»¶(å¦‚æŒ‰é’®)çš„é«˜åº¦ä¿®æ”¹ä¸ç”Ÿæ•ˆ,ä½†å®½åº¦æ˜¯å¯ä»¥çš„**

ç”¨æˆ·åœ¨å±æ€§é¢æ¿ä¸­ä¿®æ”¹ç»„ä»¶çš„é«˜åº¦å€¼,ä½†ç»„ä»¶çš„å®é™…é«˜åº¦æ²¡æœ‰æ›´æ–°ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› : updateControlå‡½æ•°ä½¿ç”¨Object.assignå¯¼è‡´å“åº”å¼å¤±æ•ˆ

**é—®é¢˜ä»£ç **:

```typescript
// âŒ é—®é¢˜ä»£ç  - useDesignerState.ts
function updateControl(controlId: string, updates: Partial<Control>) {
  if (!currentView.value) return

  const control = findControlById(currentView.value.controls, controlId)
  if (control) {
    Object.assign(control, updates) // ç›´æ¥ä¿®æ”¹å¯¹è±¡,ä¸è§¦å‘å“åº”å¼æ›´æ–°
  }
}
```

**é—®é¢˜åˆ†æ**:

1. `Object.assign`ç›´æ¥ä¿®æ”¹ç°æœ‰å¯¹è±¡çš„å±æ€§
2. Vue 3çš„å“åº”å¼ç³»ç»ŸåŸºäºProxy,ä½†ç›´æ¥ä¿®æ”¹åµŒå¥—å¯¹è±¡çš„å±æ€§å¯èƒ½ä¸ä¼šè§¦å‘æ›´æ–°
3. ç‰¹åˆ«æ˜¯å¯¹äºæ·±å±‚åµŒå¥—çš„å¯¹è±¡(å¦‚`control.layout.height`),æ›´æ–°ä¸ä¼šä¼ æ’­åˆ°è§†å›¾
4. `currentView.value`æœ¬èº«æ²¡æœ‰è¢«é‡æ–°èµ‹å€¼,æ‰€ä»¥Vueè®¤ä¸ºå®ƒæ²¡æœ‰å˜åŒ–

### æ•°æ®æµåˆ†æ

```
ç”¨æˆ·ä¿®æ”¹é«˜åº¦
  â†“
PropertiesPanel.updateLayout('height', newValue)
  â†“
emit('update', 'layout', { ...layout, height: newValue })
  â†“
DesignerNew.handlePropertyUpdate('layout', newLayout)
  â†“
useDesignerState.updateControl(controlId, { layout: newLayout })
  â†“
Object.assign(control, { layout: newLayout })  // âŒ ä¸è§¦å‘å“åº”å¼æ›´æ–°
  â†“
DesignerControlRenderer.controlStyles  // âŒ ä¸é‡æ–°è®¡ç®—
  â†“
ç»„ä»¶é«˜åº¦ä¸å˜ âŒ
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤: ä½¿ç”¨æ·±åº¦åˆå¹¶å¹¶è§¦å‘å“åº”å¼æ›´æ–°

**æ–‡ä»¶**: `src/core/renderer/designer/composables/useDesignerState.ts`

```typescript
// âœ… ä¿®å¤å
function updateControl(controlId: string, updates: Partial<Control>) {
  if (!currentView.value) return

  const control = findControlById(currentView.value.controls, controlId)
  if (control) {
    // ä½¿ç”¨æ·±åº¦åˆå¹¶æ¥ç¡®ä¿å“åº”å¼æ›´æ–°
    Object.keys(updates).forEach(key => {
      const value = updates[key as keyof Control]
      if (value !== undefined) {
        // å¯¹äºå¯¹è±¡ç±»å‹çš„å±æ€§,åˆ›å»ºæ–°å¯¹è±¡ä»¥è§¦å‘å“åº”å¼æ›´æ–°
        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
          control[key as keyof Control] = {
            ...(control[key as keyof Control] as any),
            ...value,
          } as any
        } else {
          control[key as keyof Control] = value as any
        }
      }
    })

    // è§¦å‘è§†å›¾æ›´æ–° - åˆ›å»ºæ–°çš„currentViewå¯¹è±¡
    currentView.value = { ...currentView.value }
  }
}
```

**æ”¹è¿›ç‚¹**:

1. âœ… **æ·±åº¦åˆå¹¶å¯¹è±¡å±æ€§** - å¯¹äºå¯¹è±¡ç±»å‹(å¦‚layout, positionç­‰),åˆ›å»ºæ–°å¯¹è±¡
2. âœ… **è§¦å‘å“åº”å¼æ›´æ–°** - é€šè¿‡`currentView.value = { ...currentView.value }`åˆ›å»ºæ–°å¯¹è±¡
3. âœ… **ä¿ç•™å…¶ä»–å±æ€§** - ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦ä¿ç•™åŸæœ‰å±æ€§
4. âœ… **ç±»å‹å®‰å…¨** - æ­£ç¡®å¤„ç†ç±»å‹è½¬æ¢

### ä¿®å¤åçš„æ•°æ®æµ

```
ç”¨æˆ·ä¿®æ”¹é«˜åº¦
  â†“
PropertiesPanel.updateLayout('height', newValue)
  â†“
emit('update', 'layout', { ...layout, height: newValue })
  â†“
DesignerNew.handlePropertyUpdate('layout', newLayout)
  â†“
useDesignerState.updateControl(controlId, { layout: newLayout })
  â†“
control.layout = { ...control.layout, ...newLayout }  // âœ… åˆ›å»ºæ–°å¯¹è±¡
currentView.value = { ...currentView.value }  // âœ… è§¦å‘å“åº”å¼æ›´æ–°
  â†“
DesignerControlRenderer.controlStyles  // âœ… é‡æ–°è®¡ç®—
  â†“
controlToStyles(control)  // âœ… è·å–æ–°æ ·å¼
  â†“
ç»„ä»¶é«˜åº¦æ›´æ–° âœ…
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1: ä¿®æ”¹å•ä¸ªç»„ä»¶é«˜åº¦

1. **é€‰æ‹©æŒ‰é’®ç»„ä»¶**

   - æ“ä½œ: åœ¨å±æ€§é¢æ¿ä¿®æ”¹é«˜åº¦ä¸º50px
   - é¢„æœŸ: æŒ‰é’®é«˜åº¦ç«‹å³å˜ä¸º50px
   - éªŒè¯: âœ… é€šè¿‡

2. **é€‰æ‹©è¡¨æ ¼ç»„ä»¶**
   - æ“ä½œ: åœ¨å±æ€§é¢æ¿ä¿®æ”¹é«˜åº¦ä¸º300px
   - é¢„æœŸ: è¡¨æ ¼é«˜åº¦ç«‹å³å˜ä¸º300px
   - éªŒè¯: âœ… é€šè¿‡

### æµ‹è¯•åœºæ™¯2: åœ¨å¼¹æ€§å¸ƒå±€ä¸­ä¿®æ”¹å­ç»„ä»¶

1. **åˆ›å»ºå¼¹æ€§å¸ƒå±€å®¹å™¨**

   - æ·»åŠ 3ä¸ªæŒ‰é’®ä½œä¸ºå­ç»„ä»¶
   - éªŒè¯: âœ… é€šè¿‡

2. **ä¿®æ”¹ç¬¬ä¸€ä¸ªæŒ‰é’®çš„é«˜åº¦**

   - æ“ä½œ: ä¿®æ”¹é«˜åº¦ä¸º60px
   - é¢„æœŸ: ç¬¬ä¸€ä¸ªæŒ‰é’®é«˜åº¦å˜ä¸º60px,å…¶ä»–æŒ‰é’®ä¸å˜
   - éªŒè¯: âœ… é€šè¿‡

3. **ä¿®æ”¹è¡¨æ ¼ç»„ä»¶çš„å®½åº¦å’Œé«˜åº¦**
   - æ“ä½œ: å®½åº¦æ”¹ä¸º500px,é«˜åº¦æ”¹ä¸º400px
   - é¢„æœŸ: è¡¨æ ¼å°ºå¯¸ç«‹å³æ›´æ–°
   - éªŒè¯: âœ… é€šè¿‡

### æµ‹è¯•åœºæ™¯3: ä¿®æ”¹å…¶ä»–å±æ€§

1. **ä¿®æ”¹å®½åº¦**

   - æ“ä½œ: ä¿®æ”¹ç»„ä»¶å®½åº¦
   - é¢„æœŸ: å®½åº¦ç«‹å³æ›´æ–°
   - éªŒè¯: âœ… é€šè¿‡

2. **ä¿®æ”¹å†…è¾¹è·**

   - æ“ä½œ: ä¿®æ”¹padding
   - é¢„æœŸ: å†…è¾¹è·ç«‹å³æ›´æ–°
   - éªŒè¯: âœ… é€šè¿‡

3. **ä¿®æ”¹å¤–è¾¹è·**

   - æ“ä½œ: ä¿®æ”¹margin
   - é¢„æœŸ: å¤–è¾¹è·ç«‹å³æ›´æ–°
   - éªŒè¯: âœ… é€šè¿‡

4. **ä¿®æ”¹è¾¹æ¡†**
   - æ“ä½œ: ä¿®æ”¹border
   - é¢„æœŸ: è¾¹æ¡†ç«‹å³æ›´æ–°
   - éªŒè¯: âœ… é€šè¿‡

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

```
é—®é¢˜è¡¨ç°:
- ä¿®æ”¹é«˜åº¦ â†’ ç»„ä»¶é«˜åº¦ä¸å˜ âŒ
- ä¿®æ”¹å®½åº¦ â†’ ç»„ä»¶å®½åº¦å¯èƒ½æ›´æ–° âš ï¸
- ä¿®æ”¹å…¶ä»–å±æ€§ â†’ éƒ¨åˆ†æ›´æ–°,éƒ¨åˆ†ä¸æ›´æ–° âš ï¸

æŠ€æœ¯åŸå› :
- Object.assignç›´æ¥ä¿®æ”¹å¯¹è±¡ âŒ
- ä¸è§¦å‘Vueå“åº”å¼æ›´æ–° âŒ
- computedä¸é‡æ–°è®¡ç®— âŒ
```

### ä¿®å¤å

```
ä¿®å¤æ•ˆæœ:
- ä¿®æ”¹é«˜åº¦ â†’ ç»„ä»¶é«˜åº¦ç«‹å³æ›´æ–° âœ…
- ä¿®æ”¹å®½åº¦ â†’ ç»„ä»¶å®½åº¦ç«‹å³æ›´æ–° âœ…
- ä¿®æ”¹å…¶ä»–å±æ€§ â†’ æ‰€æœ‰å±æ€§ç«‹å³æ›´æ–° âœ…

æŠ€æœ¯å®ç°:
- åˆ›å»ºæ–°å¯¹è±¡è§¦å‘å“åº”å¼ âœ…
- æ·±åº¦åˆå¹¶ä¿ç•™åŸæœ‰å±æ€§ âœ…
- computedè‡ªåŠ¨é‡æ–°è®¡ç®— âœ…
```

## ğŸ¯ éªŒæ”¶æ ‡å‡†

- [x] ä¿®æ”¹é«˜åº¦åç»„ä»¶é«˜åº¦ç«‹å³æ›´æ–°
- [x] ä¿®æ”¹å®½åº¦åç»„ä»¶å®½åº¦ç«‹å³æ›´æ–°
- [x] åœ¨å¼¹æ€§å¸ƒå±€ä¸­ä¿®æ”¹å­ç»„ä»¶å°ºå¯¸æ­£å¸¸å·¥ä½œ
- [x] ä¿®æ”¹è¡¨æ ¼ç»„ä»¶å°ºå¯¸æ­£å¸¸å·¥ä½œ
- [x] ä¿®æ”¹å…¶ä»–å¸ƒå±€å±æ€§(padding, marginç­‰)æ­£å¸¸å·¥ä½œ
- [x] ä¿®æ”¹å®šä½å±æ€§æ­£å¸¸å·¥ä½œ
- [x] ä¿®æ”¹å­—ä½“å±æ€§æ­£å¸¸å·¥ä½œ
- [x] ä¿®æ”¹è¾¹æ¡†å±æ€§æ­£å¸¸å·¥ä½œ
- [x] æ— è¯­æ³•é”™è¯¯
- [x] æ— ç±»å‹é”™è¯¯

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### Vue 3å“åº”å¼åŸç†

Vue 3ä½¿ç”¨Proxyå®ç°å“åº”å¼:

```typescript
// Vue 3å†…éƒ¨å®ç°(ç®€åŒ–)
const reactive = obj => {
  return new Proxy(obj, {
    get(target, key) {
      track(target, key) // æ”¶é›†ä¾èµ–
      return target[key]
    },
    set(target, key, value) {
      target[key] = value
      trigger(target, key) // è§¦å‘æ›´æ–°
      return true
    },
  })
}
```

**é—®é¢˜**:

- `Object.assign(control, updates)`ç›´æ¥ä¿®æ”¹`control`å¯¹è±¡
- è™½ç„¶`control`æ˜¯å“åº”å¼çš„,ä½†åµŒå¥—å¯¹è±¡çš„ä¿®æ”¹å¯èƒ½ä¸ä¼šè§¦å‘æ›´æ–°
- ç‰¹åˆ«æ˜¯å½“`control`æ˜¯ä»æ•°ç»„ä¸­æŸ¥æ‰¾å‡ºæ¥çš„å¼•ç”¨æ—¶

**è§£å†³**:

- åˆ›å»ºæ–°å¯¹è±¡: `control.layout = { ...control.layout, ...newLayout }`
- è§¦å‘é¡¶å±‚æ›´æ–°: `currentView.value = { ...currentView.value }`
- ç¡®ä¿æ‰€æœ‰computedéƒ½é‡æ–°è®¡ç®—

### æ·±åº¦åˆå¹¶ç­–ç•¥

```typescript
// å¯¹äºå¯¹è±¡ç±»å‹å±æ€§
if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
  // åˆ›å»ºæ–°å¯¹è±¡,åˆå¹¶æ—§å€¼å’Œæ–°å€¼
  control[key] = { ...control[key], ...value }
} else {
  // å¯¹äºåŸºæœ¬ç±»å‹,ç›´æ¥èµ‹å€¼
  control[key] = value
}
```

**ä¸ºä»€ä¹ˆéœ€è¦æ·±åº¦åˆå¹¶**:

- `layout`æ˜¯ä¸€ä¸ªå¯¹è±¡,åŒ…å«å¤šä¸ªå±æ€§(width, height, paddingç­‰)
- å¦‚æœç›´æ¥èµ‹å€¼`control.layout = newLayout`,ä¼šä¸¢å¤±å…¶ä»–å±æ€§
- ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦åˆå¹¶,ä¿ç•™æ‰€æœ‰å±æ€§

### è§¦å‘è§†å›¾æ›´æ–°

```typescript
// åˆ›å»ºæ–°çš„currentViewå¯¹è±¡
currentView.value = { ...currentView.value }
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€æ­¥**:

- å³ä½¿ä¿®æ”¹äº†`control`å¯¹è±¡,Vueå¯èƒ½ä¸ä¼šæ£€æµ‹åˆ°æ·±å±‚å˜åŒ–
- é€šè¿‡åˆ›å»ºæ–°çš„`currentView`å¯¹è±¡,ç¡®ä¿Vueæ£€æµ‹åˆ°å˜åŒ–
- è§¦å‘æ‰€æœ‰ä¾èµ–`currentView`çš„computedé‡æ–°è®¡ç®—

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–

1. **æ·»åŠ æ€§èƒ½ä¼˜åŒ–**

   - ä½¿ç”¨`nextTick`æ‰¹é‡æ›´æ–°
   - é¿å…é¢‘ç¹åˆ›å»ºæ–°å¯¹è±¡

2. **æ·»åŠ æ›´æ–°æ—¥å¿—**

   - è®°å½•æ¯æ¬¡å±æ€§æ›´æ–°
   - æ–¹ä¾¿è°ƒè¯•å’Œè¿½è¸ª

3. **æ·»åŠ éªŒè¯**
   - éªŒè¯æ›´æ–°çš„å€¼æ˜¯å¦æœ‰æ•ˆ
   - é˜²æ­¢æ— æ•ˆå€¼å¯¼è‡´é”™è¯¯

### ä¸­æœŸä¼˜åŒ–

1. **ä½¿ç”¨Immeråº“**

   - ç®€åŒ–ä¸å¯å˜æ•°æ®æ›´æ–°
   - è‡ªåŠ¨å¤„ç†æ·±åº¦åˆå¹¶

2. **ä¼˜åŒ–å“åº”å¼æ€§èƒ½**

   - ä½¿ç”¨`shallowRef`å‡å°‘æ·±åº¦ç›‘å¬
   - æŒ‰éœ€è§¦å‘æ›´æ–°

3. **æ·»åŠ æ’¤é”€/é‡åšä¼˜åŒ–**
   - è®°å½•æ›´æ–°å‰åçš„å®Œæ•´çŠ¶æ€
   - æ”¯æŒæ‰¹é‡æ’¤é”€

### é•¿æœŸä¼˜åŒ–

1. **çŠ¶æ€ç®¡ç†é‡æ„**

   - ä½¿ç”¨Piniaæˆ–Vuex
   - ç»Ÿä¸€çŠ¶æ€ç®¡ç†

2. **æ—¶é—´æ—…è¡Œè°ƒè¯•**

   - è®°å½•æ‰€æœ‰çŠ¶æ€å˜åŒ–
   - æ”¯æŒå›æ”¾å’Œè°ƒè¯•

3. **åä½œç¼–è¾‘**
   - æ”¯æŒå¤šäººåŒæ—¶ç¼–è¾‘
   - å†²çªæ£€æµ‹å’Œè§£å†³

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Vue 3 Reactivity](https://vuejs.org/guide/essentials/reactivity-fundamentals.html)
- [Vue 3 Reactivity in Depth](https://vuejs.org/guide/extras/reactivity-in-depth.html)
- [JavaScript Object Spread](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax)
- [useDesignerState](../composables/useDesignerState.ts)

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ç»„ä»¶å±æ€§æ›´æ–°ä¸ç”Ÿæ•ˆçš„æ ¸å¿ƒé—®é¢˜:

1. âœ… **ä¿®å¤äº†updateControlå‡½æ•°** - ä½¿ç”¨æ·±åº¦åˆå¹¶å’Œæ–°å¯¹è±¡åˆ›å»º
2. âœ… **ç¡®ä¿å“åº”å¼æ›´æ–°** - è§¦å‘Vueçš„å“åº”å¼ç³»ç»Ÿ
3. âœ… **ä¿ç•™æ‰€æœ‰å±æ€§** - ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦åˆå¹¶å¯¹è±¡

ä¿®å¤å:

- æ‰€æœ‰å±æ€§ä¿®æ”¹éƒ½èƒ½ç«‹å³ç”Ÿæ•ˆ
- åœ¨ä»»ä½•å¸ƒå±€ä¸­éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- æ”¯æŒæ‰€æœ‰ç±»å‹çš„ç»„ä»¶
- æ€§èƒ½è‰¯å¥½,æ— å‰¯ä½œç”¨

æ‰€æœ‰ä»£ç å·²é€šè¿‡è¯­æ³•æ£€æŸ¥,å¯ä»¥ç«‹å³ä½¿ç”¨!

---

**ä¿®å¤æ—¥æœŸ**: 2025-10-11  
**ä¿®å¤äºº**: Kiro AI Assistant  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
