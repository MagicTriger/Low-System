# 设计器关键问题修复需求文档

## 介绍

本文档定义了设计器中两个关键问题的修复需求：

1. 大屏组件拖拽导致浏览器崩溃（无限循环）
2. 数据源配置功能完善

## 需求

### 需求 1: 修复大屏组件拖拽崩溃问题

**用户故事：** 作为设计器用户，我希望能够正常拖拽大屏组件到画布，而不会导致浏览器崩溃

#### 验收标准

1. WHEN 用户拖拽大屏组件（数据面板或大屏容器）到画布 THEN 系统应该正常添加组件，不会出现无限循环
2. WHEN 组件被添加到画布 THEN 控制台不应该出现递增的注册消息
3. WHEN 组件在画布上渲染 THEN 浏览器应该保持响应，不会崩溃或卡死
4. WHEN 用户选中或悬停大屏组件 THEN 系统应该正常更新选择框，不会触发无限更新
5. IF 组件的 DOM 发生变化 THEN 系统应该智能地更新矩形位置，避免触发新的 DOM 变化

**技术分析：**

- 根本原因：`DesignerControlRenderer.vue` 中的 MutationObserver 监听 DOM 变化并调用 `updateControlRect()`
- `updateControlRect()` 中的 `console.log` 会触发 DOM 更新（在某些浏览器中）
- 这导致 MutationObserver 再次触发，形成无限循环
- `watch` 使用 `deep: true` 监听整个 control 对象，也可能触发过多更新

**边界情况：**

- 大屏组件有深色背景和复杂样式
- 大屏容器是容器组件，可以包含子组件
- 数据面板是普通组件，不包含子组件

---

### 需求 2: 完善数据源配置功能

**用户故事：** 作为设计器用户，我希望能够通过全屏弹框配置数据源、数据流和数据操作，为组件的数据绑定提供基础

#### 验收标准

1. WHEN 用户点击顶部工具栏的"数据源"按钮 THEN 系统应该打开全屏配置弹框
2. WHEN 配置弹框打开 THEN 应该显示三个主要配置区域：数据源、数据流、数据操作
3. WHEN 用户在数据源区域 THEN 应该能够添加、编辑、删除数据源配置
4. WHEN 用户配置数据源 THEN 应该支持多种数据源类型（API、静态数据、Mock数据）
5. WHEN 用户在数据流区域 THEN 应该能够配置数据转换和处理逻辑
6. WHEN 用户在数据操作区域 THEN 应该能够配置数据的增删改查操作
7. WHEN 用户保存配置 THEN 系统应该验证配置的完整性和正确性
8. WHEN 用户关闭弹框 THEN 系统应该保存配置到设计状态中
9. WHEN 组件需要绑定数据 THEN 应该能够从已配置的数据源中选择

**功能要求：**

#### 2.1 数据源配置

- 支持添加多个数据源
- 每个数据源包含：
  - 名称和标识
  - 类型（API/静态/Mock）
  - 连接配置（URL、方法、参数等）
  - 数据结构定义（字段元数据）
  - 自动加载选项

#### 2.2 数据流配置

- 支持数据转换管道
- 支持数据过滤
- 支持数据映射
- 支持数据聚合
- 可视化数据流图

#### 2.3 数据操作配置

- 支持 CRUD 操作定义
- 支持操作参数配置
- 支持操作前后钩子
- 支持操作权限控制

**UI 要求：**

- 全屏模态框（覆盖整个设计器）
- 左侧导航：数据源列表
- 中间区域：配置表单
- 右侧面板：预览和测试
- 底部操作栏：保存、取消、测试连接

**技术要求：**

- 使用 Ant Design Vue 的 Modal 组件（fullscreen 模式）
- 使用 Tabs 组件切换配置区域
- 使用 Form 组件进行表单验证
- 使用 Monaco Editor 编辑 JSON 配置
- 支持配置的导入导出

---

## 成功标准

### 修复验证

1. 所有大屏组件可以正常拖拽到画布
2. 控制台没有无限递增的日志
3. 浏览器保持响应，不会崩溃
4. 组件选择和悬停功能正常

### 数据源配置验证

1. 可以打开全屏配置弹框
2. 可以添加、编辑、删除数据源
3. 可以配置数据流和数据操作
4. 配置可以正确保存和加载
5. 组件可以绑定到配置的数据源

---

## 技术约束

1. 必须保持现有的组件渲染逻辑
2. 必须兼容现有的数据绑定机制
3. 必须支持撤销/重做功能
4. 必须保持良好的性能（无卡顿）
5. 必须提供清晰的错误提示

---

## 优先级

1. **P0 - 紧急：** 修复大屏组件崩溃问题（阻塞功能）
2. **P1 - 高：** 实现数据源配置基础功能
3. **P2 - 中：** 实现数据流配置
4. **P3 - 低：** 实现数据操作配置

---

## 依赖关系

- 数据源配置依赖于崩溃问题修复
- 数据流配置依赖于数据源配置
- 数据操作配置依赖于数据源配置
- 组件数据绑定依赖于数据源配置

---

**创建日期：** 2025-10-11  
**创建人：** Kiro AI Assistant  
**状态：** 待审核
