var z=Object.defineProperty;var F=(l,e,t)=>e in l?z(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var g=(l,e,t)=>F(l,typeof e!="symbol"?e+"":e,t);import{bm as q,h as k,f as O,d as K,r as I,bo as S,bp as T,bE as a,z as b,u as U,R as H,I as P,bz as C,bX as _,bq as L,bF as v,b_ as G,bt as $,b$ as j,bY as J,V as D}from"./vendor.BT0Of-np.js";import{_ as V}from"./index.MMW6Q6l4.js";import{I as R}from"./Icon.BM9XfUDI.js";import"./antdv.B3VvJiRs.js";/* empty css                                                             */const X={cacheEnabled:!0,cacheTTL:3e5,strictMode:!0,inheritanceEnabled:!0,policyEvaluationTimeout:5e3};class W{constructor(e={}){g(this,"config");g(this,"policies",new Map);g(this,"permissionCache",new Map);g(this,"roleHierarchy",new Map);g(this,"resourceHierarchy",new Map);this.config={...X,...e},this.setupCacheCleanup()}setupCacheCleanup(){this.config.cacheEnabled&&setInterval(()=>{this.cleanExpiredCache()},this.config.cacheTTL)}cleanExpiredCache(){const e=Date.now();for(const[t,s]of this.permissionCache)e-s.timestamp>s.ttl&&this.permissionCache.delete(t)}generateCacheKey(e,t,s){const r=s?JSON.stringify(s):"";return`${e}:${t}:${r}`}getCachedResult(e){if(!this.config.cacheEnabled)return null;const t=this.permissionCache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.permissionCache.delete(e),null):t.result:null}setCachedResult(e,t,s){this.config.cacheEnabled&&this.permissionCache.set(e,{result:t,timestamp:Date.now(),ttl:s||this.config.cacheTTL})}hasPermission(e,t){const s=this.generateCacheKey(e.id,t),r=this.getCachedResult(s);if(r!==null)return r;let i=!1;return i=e.permissions.some(n=>n.code===t),i||(i=e.roles.some(n=>n.permissions.some(o=>o.code===t))),!i&&this.config.inheritanceEnabled&&(i=this.checkPermissionInheritance(e,t)),!i&&this.config.strictMode&&(i=!1),this.setCachedResult(s,i),i}checkPermissionInheritance(e,t){const{resource:s,action:r}=N.parsePermissionCode(t),i=this.getParentResources(s);for(const o of i){const h=N.formatPermissionCode(o,r);if(this.hasDirectPermission(e,h))return!0}const n=this.getAllInheritedRoles(e.roles.map(o=>o.code));for(const o of n);return!1}hasDirectPermission(e,t){return e.permissions.some(s=>s.code===t)||e.roles.some(s=>s.permissions.some(r=>r.code===t))}getParentResources(e){return this.resourceHierarchy.get(e)||[]}getAllInheritedRoles(e){const t=new Set(e);for(const s of e)(this.roleHierarchy.get(s)||[]).forEach(i=>t.add(i));return Array.from(t)}hasRole(e,t){if(e.roles.some(r=>r.code===t))return!0;if(this.config.inheritanceEnabled){const r=e.roles.map(n=>n.code);return this.getAllInheritedRoles(r).includes(t)}return!1}canAccess(e,t,s="read"){const r=N.formatPermissionCode(t,s);return this.hasPermission(e,r)}getUserPermissions(e){const t=new Set;return e.permissions.forEach(s=>t.add(s.code)),e.roles.forEach(s=>{s.permissions.forEach(r=>t.add(r.code))}),this.config.inheritanceEnabled&&this.getInheritedPermissions(e).forEach(r=>t.add(r)),Array.from(t)}getInheritedPermissions(e){const t=new Set,s=e.roles.map(r=>r.code);return this.getAllInheritedRoles(s),Array.from(t)}getUserRoles(e){const t=new Set;if(e.roles.forEach(s=>t.add(s.code)),this.config.inheritanceEnabled){const s=e.roles.map(i=>i.code);this.getAllInheritedRoles(s).forEach(i=>t.add(i))}return Array.from(t)}addPolicy(e){this.policies.set(e.name,e)}removePolicy(e){this.policies.delete(e)}async evaluatePolicy(e){const t=[];for(const[s,r]of this.policies){const i=Promise.resolve(r.evaluate(e)).then(n=>n).catch(n=>(console.error(`Policy evaluation error for ${s}:`,n),!1));t.push(i)}try{const s=new Promise((i,n)=>{setTimeout(()=>n(new Error("Policy evaluation timeout")),this.config.policyEvaluationTimeout)});return(await Promise.race([Promise.all(t),s])).every(i=>i)}catch(s){return console.error("Policy evaluation failed:",s),!1}}async checkPermission(e,t,s){if(!this.hasPermission(e,t))return{allowed:!1,reason:"Insufficient permissions",requiredPermissions:[t],userPermissions:this.getUserPermissions(e)};if(this.policies.size>0){const i={user:e,resource:N.parsePermissionCode(t).resource,action:N.parsePermissionCode(t).action,data:s};if(!await this.evaluatePolicy(i))return{allowed:!1,reason:"Policy evaluation failed",requiredPermissions:[t],userPermissions:this.getUserPermissions(e)}}return{allowed:!0,userPermissions:this.getUserPermissions(e)}}async checkPermissions(e,t,s){const r={};for(const i of t)r[i]=await this.checkPermission(e,i,s);return r}setRoleHierarchy(e,t){this.roleHierarchy.set(e,t)}setResourceHierarchy(e,t){this.resourceHierarchy.set(e,t)}clearCache(e){if(e)for(const[t]of this.permissionCache)t.startsWith(`${e}:`)&&this.permissionCache.delete(t);else this.permissionCache.clear()}getStats(){return{policiesCount:this.policies.size,cacheSize:this.permissionCache.size,roleHierarchySize:this.roleHierarchy.size,resourceHierarchySize:this.resourceHierarchy.size,config:{...this.config}}}destroy(){this.policies.clear(),this.permissionCache.clear(),this.roleHierarchy.clear(),this.resourceHierarchy.clear()}}function Z(l){return new W(l)}Z();const Y={enableCache:!0,cacheTimeout:3e5,enableAuditLog:!0,passwordPolicy:{minLength:8,requireUppercase:!0,requireLowercase:!0,requireNumbers:!0,requireSpecialChars:!1}};class Q{constructor(e={}){g(this,"config");g(this,"users",new Map);g(this,"usersByEmail",new Map);g(this,"usersByUsername",new Map);g(this,"userCache",new Map);g(this,"auditLogs",[]);this.config={...Y,...e},this.setupCacheCleanup()}setupCacheCleanup(){this.config.enableCache&&setInterval(()=>{this.cleanExpiredCache()},this.config.cacheTimeout)}cleanExpiredCache(){const e=Date.now();for(const[t,s]of this.userCache)e-s.timestamp>this.config.cacheTimeout&&this.userCache.delete(t)}logAudit(e,t,s){this.config.enableAuditLog&&this.auditLogs.push({userId:e,action:t,timestamp:Date.now(),details:s})}validatePassword(e){const t=this.config.passwordPolicy;return t?!(e.length<t.minLength||t.requireUppercase&&!/[A-Z]/.test(e)||t.requireLowercase&&!/[a-z]/.test(e)||t.requireNumbers&&!/\d/.test(e)||t.requireSpecialChars&&!/[!@#$%^&*(),.?":{}|<>]/.test(e)):!0}generateUserId(){return`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async createUser(e){if(!e.username)throw new d("Username is required");if(!e.email)throw new d("Email is required");if(this.usersByUsername.has(e.username))throw new d("Username already exists");if(this.usersByEmail.has(e.email))throw new d("Email already exists");const t=this.generateUserId(),s=new Date,r={id:t,username:e.username,email:e.email,status:e.status||"active",roles:e.roles||[],permissions:e.permissions||[],profile:e.profile||{firstName:"",lastName:"",phone:"",department:"",position:"",bio:"",preferences:{}},createdAt:s,updatedAt:s,lastLoginAt:e.lastLoginAt||void 0};return this.users.set(t,r),this.usersByEmail.set(e.email,r),this.usersByUsername.set(e.username,r),this.logAudit(t,"USER_CREATED",{username:e.username,email:e.email}),r}async getUserById(e){if(this.config.enableCache){const s=this.userCache.get(e);if(s&&Date.now()-s.timestamp<this.config.cacheTimeout)return s.user}const t=this.users.get(e)||null;return t&&this.config.enableCache&&this.userCache.set(e,{user:t,timestamp:Date.now()}),t}async getUserByUsername(e){return this.usersByUsername.get(e)||null}async getUserByEmail(e){return this.usersByEmail.get(e)||null}async updateUser(e,t){const s=await this.getUserById(e);if(!s)throw new d("User not found");if(t.username&&t.username!==s.username&&this.usersByUsername.has(t.username))throw new d("Username already exists");if(t.email&&t.email!==s.email&&this.usersByEmail.has(t.email))throw new d("Email already exists");t.username&&t.username!==s.username&&(this.usersByUsername.delete(s.username),this.usersByUsername.set(t.username,s)),t.email&&t.email!==s.email&&(this.usersByEmail.delete(s.email),this.usersByEmail.set(t.email,s));const r={...s,...t,id:s.id,createdAt:s.createdAt,updatedAt:new Date};return this.users.set(e,r),this.userCache.delete(e),this.logAudit(e,"USER_UPDATED",t),r}async deleteUser(e){const t=await this.getUserById(e);if(!t)throw new d("User not found");this.users.delete(e),this.usersByEmail.delete(t.email),this.usersByUsername.delete(t.username),this.userCache.delete(e),this.logAudit(e,"USER_DELETED",{username:t.username,email:t.email})}async getUsersInternal(e={}){const{page:t=1,pageSize:s=20,sortBy:r="createdAt",sortOrder:i="desc",filters:n={}}=e;let o=Array.from(this.users.values());Object.keys(n).length>0&&(o=o.filter(w=>Object.entries(n).every(([u,p])=>{var A,M;if(u==="status")return w.status===p;if(u==="search"){const B=p.toLowerCase();return w.username.toLowerCase().includes(B)||w.email.toLowerCase().includes(B)||((A=w.profile)==null?void 0:A.firstName)&&w.profile.firstName.toLowerCase().includes(B)||((M=w.profile)==null?void 0:M.lastName)&&w.profile.lastName.toLowerCase().includes(B)}return!0}))),o.sort((w,u)=>{let p=w[r],A=u[r];return p instanceof Date&&(p=p.getTime()),A instanceof Date&&(A=A.getTime()),i==="asc"?p>A?1:-1:p<A?1:-1});const h=o.length,m=Math.ceil(h/s),c=(t-1)*s,f=c+s;return{users:o.slice(c,f),total:h,page:t,pageSize:s,totalPages:m}}async updateUserStatus(e,t){return this.updateUser(e,{status:t})}async assignRoles(e,t){const s=await this.getUserById(e);if(!s)throw new d("User not found");const r=t.map(n=>({id:n,code:n,name:n,description:"",permissions:[],isSystem:!1,status:"active",createdAt:new Date,updatedAt:new Date})),i={...s,roles:r,updatedAt:new Date};return this.users.set(e,i),this.userCache.delete(e),this.logAudit(e,"ROLES_ASSIGNED",{roleIds:t}),i}async assignPermissions(e,t){const s=await this.getUserById(e);if(!s)throw new d("User not found");const r=t.map(n=>({id:n,code:n,name:n,description:"",resource:"",action:"",isSystem:!1,createdAt:new Date,updatedAt:new Date})),i={...s,permissions:r,updatedAt:new Date};return this.users.set(e,i),this.userCache.delete(e),this.logAudit(e,"PERMISSIONS_ASSIGNED",{permissionIds:t}),i}async updateLastLogin(e){const t=await this.getUserById(e);t&&(t.lastLoginAt=new Date,this.users.set(e,t),this.userCache.delete(e),this.logAudit(e,"USER_LOGIN"))}async getUserStats(){const e=Array.from(this.users.values());return{total:e.length,active:e.filter(t=>t.status==="active").length,inactive:e.filter(t=>t.status==="inactive").length,banned:e.filter(t=>t.status==="banned").length}}async getUser(e){return this.getUserById(e)}async getUsers(e){let t=Array.from(this.users.values());if(e!=null&&e.search){const r=e.search.toLowerCase();t=t.filter(i=>{var n,o;return i.username.toLowerCase().includes(r)||i.email.toLowerCase().includes(r)||((n=i.profile)==null?void 0:n.firstName)&&i.profile.firstName.toLowerCase().includes(r)||((o=i.profile)==null?void 0:o.lastName)&&i.profile.lastName.toLowerCase().includes(r)})}e!=null&&e.status&&(t=t.filter(r=>r.status===e.status)),e!=null&&e.role&&(t=t.filter(r=>r.roles.some(i=>i.code===e.role)));const s=t.length;if(e!=null&&e.page&&(e!=null&&e.limit)){const r=(e.page-1)*e.limit;t=t.slice(r,r+e.limit)}return{users:t,total:s}}async assignRole(e,t){const s=await this.getUserById(e);if(!s)throw new d("User not found");if(s.roles.some(o=>o.id===t))return;const i={id:t,code:t,name:t,description:"",permissions:[],isSystem:!1,status:"active",createdAt:new Date,updatedAt:new Date},n={...s,roles:[...s.roles,i],updatedAt:new Date};this.users.set(e,n),this.usersByEmail.set(s.email,n),this.usersByUsername.set(s.username,n),this.userCache.delete(e),this.logAudit(e,"ROLE_ASSIGNED",{roleId:t})}async removeRole(e,t){const s=await this.getUserById(e);if(!s)throw new d("User not found");const r={...s,roles:s.roles.filter(i=>i.id!==t),updatedAt:new Date};this.users.set(e,r),this.usersByEmail.set(s.email,r),this.usersByUsername.set(s.username,r),this.userCache.delete(e),this.logAudit(e,"ROLE_REMOVED",{roleId:t})}async assignPermission(e,t){const s=await this.getUserById(e);if(!s)throw new d("User not found");if(s.permissions.some(o=>o.id===t))return;const i={id:t,code:t,name:t,description:"",resource:t.split(":")[0]||"",action:t.split(":")[1]||"read",isSystem:!1,createdAt:new Date,updatedAt:new Date},n={...s,permissions:[...s.permissions,i],updatedAt:new Date};this.users.set(e,n),this.usersByEmail.set(s.email,n),this.usersByUsername.set(s.username,n),this.userCache.delete(e),this.logAudit(e,"PERMISSION_ASSIGNED",{permissionId:t})}async removePermission(e,t){const s=await this.getUserById(e);if(!s)throw new d("User not found");const r={...s,permissions:s.permissions.filter(i=>i.id!==t),updatedAt:new Date};this.users.set(e,r),this.usersByEmail.set(s.email,r),this.usersByUsername.set(s.username,r),this.userCache.delete(e),this.logAudit(e,"PERMISSION_REMOVED",{permissionId:t})}getAuditLogs(e,t=100){let s=this.auditLogs;return e&&(s=s.filter(r=>r.userId===e)),s.sort((r,i)=>i.timestamp-r.timestamp).slice(0,t)}clearCache(e){e?this.userCache.delete(e):this.userCache.clear()}destroy(){this.users.clear(),this.usersByEmail.clear(),this.usersByUsername.clear(),this.userCache.clear(),this.auditLogs.length=0}}function ee(l){return new Q(l)}ee();const te={enableCache:!0,cacheTimeout:3e5,enableAuditLog:!0,enableHierarchy:!0,maxHierarchyDepth:5};class se{constructor(e={}){g(this,"config");g(this,"roles",new Map);g(this,"rolesByCode",new Map);g(this,"roleCache",new Map);g(this,"roleHierarchy",new Map);g(this,"auditLogs",[]);this.config={...te,...e},this.setupCacheCleanup()}setupCacheCleanup(){this.config.enableCache&&setInterval(()=>{this.cleanExpiredCache()},this.config.cacheTimeout)}cleanExpiredCache(){const e=Date.now();for(const[t,s]of this.roleCache)e-s.timestamp>this.config.cacheTimeout&&this.roleCache.delete(t)}logAudit(e,t,s){this.config.enableAuditLog&&this.auditLogs.push({roleId:e,action:t,timestamp:Date.now(),details:s})}generateRoleId(){return`role_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}checkCircularDependency(e,t){const s=new Set,r=new Set,i=h=>{if(r.has(h))return!0;if(s.has(h))return!1;s.add(h),r.add(h);const m=this.roleHierarchy.get(h)||[];for(const c of m)if(i(c))return!0;return r.delete(h),!1},n=this.roleHierarchy.get(e)||[];this.roleHierarchy.set(e,t);const o=i(e);return this.roleHierarchy.set(e,n),o}getAllParentRoles(e){const t=new Set,s=new Set,r=i=>{if(s.has(i))return;s.add(i);const n=this.roleHierarchy.get(i)||[];for(const o of n)t.add(o),r(o)};return r(e),Array.from(t)}getAllChildRoles(e){const t=new Set,s=new Set,r=i=>{if(!s.has(i)){s.add(i);for(const[n,o]of this.roleHierarchy)o.includes(i)&&(t.add(n),r(n))}};return r(e),Array.from(t)}async createRole(e){if(!e.code||!e.name)throw new d("角色代码和名称是必需的");if(this.rolesByCode.has(e.code))throw new d(`角色代码 ${e.code} 已存在`);const t=this.generateRoleId(),s=new Date,r={id:t,code:e.code,name:e.name,description:e.description||"",permissions:e.permissions||[],isSystem:e.isSystem||!1,status:e.status||"active",createdAt:s,updatedAt:s};return this.roles.set(t,r),this.rolesByCode.set(r.code,r),this.logAudit(t,"create",{roleData:e}),r}async getRoleById(e){if(this.config.enableCache){const s=this.roleCache.get(e);if(s&&Date.now()-s.timestamp<this.config.cacheTimeout)return s.role}const t=this.roles.get(e)||null;return t&&this.config.enableCache&&this.roleCache.set(e,{role:t,timestamp:Date.now()}),t}async getRoleByCode(e){return this.rolesByCode.get(e)||null}async updateRole(e,t){const s=this.roles.get(e);if(!s)throw new d(`角色 ${e} 不存在`);if(t.code&&t.code!==s.code){if(this.rolesByCode.has(t.code))throw new d(`角色代码 ${t.code} 已存在`);this.rolesByCode.delete(s.code),this.rolesByCode.set(t.code,s)}const r={...s,...t,id:e,updatedAt:new Date};return this.roles.set(e,r),this.clearCache(e),this.logAudit(e,"update",{roleData:t}),r}async deleteRole(e){const t=this.roles.get(e);if(!t)throw new d("Role not found");if(t.isSystem)throw new d("Cannot delete system role");this.roles.delete(e),this.rolesByCode.delete(t.code),this.clearCache(e),this.logAudit(e,"ROLE_DELETED",{code:t.code,name:t.name})}async queryRoles(e={}){const{page:t=1,pageSize:s=20,sortBy:r="createdAt",sortOrder:i="desc",filters:n={}}=e;let o=Array.from(this.roles.values());Object.keys(n).length>0&&(o=o.filter(w=>Object.entries(n).every(([u,p])=>{if(u==="search"){const A=p.toLowerCase();return w.code.toLowerCase().includes(A)||w.name.toLowerCase().includes(A)||w.description&&w.description.toLowerCase().includes(A)}return!0}))),o.sort((w,u)=>{let p=w[r],A=u[r];return p instanceof Date&&(p=p.getTime()),A instanceof Date&&(A=A.getTime()),i==="asc"?p>A?1:-1:p<A?1:-1});const h=o.length,m=Math.ceil(h/s),c=(t-1)*s,f=c+s;return{roles:o.slice(c,f),total:h,page:t,pageSize:s,totalPages:m}}async assignPermission(e,t){const s=this.roles.get(e);if(!s)throw new d(`角色 ${e} 不存在`);if(s.permissions.some(n=>n.id===t))return;const i={id:t,name:`Permission ${t}`,code:`perm_${t}`,resource:"unknown",action:"unknown",isSystem:!1,createdAt:new Date,updatedAt:new Date};s.permissions.push(i),s.updatedAt=new Date,this.roles.set(e,s),this.clearCache(e),this.logAudit(e,"assign_permission",{permissionId:t})}async removePermission(e,t){const s=this.roles.get(e);if(!s)throw new d(`角色 ${e} 不存在`);const r=s.permissions.length;s.permissions=s.permissions.filter(i=>i.id!==t),s.permissions.length<r&&(s.updatedAt=new Date,this.roles.set(e,s),this.clearCache(e),this.logAudit(e,"remove_permission",{permissionId:t}))}async getRolePermissions(e){const t=await this.getRoleByCode(e);if(!t)return[];const s=new Map;if(t.permissions.forEach(r=>{s.set(r.code,r)}),this.config.enableHierarchy){const r=this.getAllParentRoles(e);for(const i of r){const n=await this.getRoleByCode(i);n&&n.permissions.forEach(o=>{s.set(o.code,o)})}}return Array.from(s.values())}getRoleHierarchy(e){return{parents:this.roleHierarchy.get(e)||[],children:Array.from(this.roleHierarchy.entries()).filter(([t,s])=>s.includes(e)).map(([t])=>t),allParents:this.getAllParentRoles(e),allChildren:this.getAllChildRoles(e)}}async setRoleHierarchy(e,t){if(this.checkCircularDependency(e,t))throw new d("Circular dependency detected in role hierarchy");for(const r of t)if(!await this.getRoleByCode(r))throw new d(`Parent role not found: ${r}`);this.roleHierarchy.set(e,t);const s=await this.getRoleByCode(e);s&&this.logAudit(s.id,"HIERARCHY_UPDATED",{parentRoleCodes:t})}async getRoleStats(){const e=Array.from(this.roles.values());return{total:e.length,withPermissions:e.filter(t=>t.permissions.length>0).length,withHierarchy:this.roleHierarchy.size,maxDepth:this.calculateMaxHierarchyDepth()}}calculateMaxHierarchyDepth(){let e=0;const t=(s,r=new Set)=>{if(r.has(s))return 0;r.add(s);const i=this.roleHierarchy.get(s)||[];if(i.length===0)return 1;let n=0;for(const o of i){const h=t(o,new Set(r));n=Math.max(n,h)}return n+1};for(const s of this.roleHierarchy.keys()){const r=t(s);e=Math.max(e,r)}return e}getAuditLogs(e,t=100){let s=this.auditLogs;return e&&(s=s.filter(r=>r.roleId===e)),s.sort((r,i)=>i.timestamp-r.timestamp).slice(0,t)}async getRoles(){return Array.from(this.roles.values())}async getRole(e){return this.getRoleById(e)}destroy(){this.roles.clear(),this.rolesByCode.clear(),this.roleCache.clear(),this.roleHierarchy.clear(),this.auditLogs.length=0}clearCache(e){e?this.roleCache.delete(e):this.roleCache.clear()}}function re(l){return new se(l)}re();var E=(l=>(l.AUTHENTICATED="authenticated",l.UNAUTHENTICATED="unauthenticated",l.EXPIRED="expired",l.INVALID="invalid",l.LOADING="loading",l))(E||{});class d extends Error{constructor(e,t="AUTH_FAILED",s=401){super(e),this.code=t,this.statusCode=s,this.name="AuthError"}}class N{static formatPermissionCode(e,t){return`${e}:${t}`}static parsePermissionCode(e){const[t,s]=e.split(":");return{resource:t,action:s}}static isValidPermissionCode(e){return/^[a-zA-Z0-9_-]+:[a-zA-Z0-9_-]+$/.test(e)}static mergePermissions(...e){const t=new Map;return e.flat().forEach(s=>{t.set(s.code,s)}),Array.from(t.values())}static filterPermissions(e,t){return e.filter(t)}static groupPermissionsByResource(e){return e.reduce((t,s)=>{const r=s.resource;return t[r]||(t[r]=[]),t[r].push(s),t},{})}}const ie={apiBaseUrl:"/api/auth",tokenStorageKey:"auth_token",refreshTokenStorageKey:"refresh_token",userStorageKey:"current_user",tokenExpirationBuffer:300,autoRefresh:!0,rememberMeDuration:30};class ne{constructor(e={}){g(this,"config");g(this,"currentUser",null);g(this,"currentToken",null);g(this,"authStatus",E.UNAUTHENTICATED);g(this,"refreshTimer",null);g(this,"eventListeners",new Map);g(this,"authStateListeners",[]);this.config={...ie,...e},this.initialize()}initialize(){this.loadStoredAuth(),this.setupAutoRefresh()}loadStoredAuth(){try{const e=localStorage.getItem(this.config.tokenStorageKey),t=localStorage.getItem(this.config.userStorageKey);if(e&&t){const s=JSON.parse(e),r=JSON.parse(t);new Date(s.expiresAt)>new Date?(this.currentToken=s,this.currentUser=r,this.authStatus=E.AUTHENTICATED,this.notifyAuthStateChange()):(this.clearStoredAuth(),this.authStatus=E.EXPIRED)}}catch(e){console.error("Failed to load stored auth:",e),this.clearStoredAuth()}}setupAutoRefresh(){if(!this.config.autoRefresh||!this.currentToken)return;const e=new Date(this.currentToken.expiresAt),t=new Date,r=e.getTime()-t.getTime()-this.config.tokenExpirationBuffer*1e3;r>0&&(this.refreshTimer=setTimeout(()=>{this.refreshToken().catch(i=>{console.error("Auto refresh failed:",i),this.handleAuthError(new d("Token refresh failed","TOKEN_REFRESH_FAILED"))})},r))}async login(e){try{this.authStatus=E.LOADING,this.notifyAuthStateChange();const t=await fetch(`${this.config.apiBaseUrl}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json();if(!t.ok)throw new d(s.message||"Login failed","LOGIN_FAILED",t.status);return s.success&&s.user&&s.token?(this.currentUser=s.user,this.currentToken=s.token,this.authStatus=E.AUTHENTICATED,this.storeAuth(s.user,s.token,e.rememberMe),this.setupAutoRefresh(),this.emitEvent({type:"login",user:s.user,token:s.token,timestamp:new Date}),this.notifyAuthStateChange()):(this.authStatus=E.UNAUTHENTICATED,this.notifyAuthStateChange()),s}catch(t){throw this.authStatus=E.UNAUTHENTICATED,this.notifyAuthStateChange(),t instanceof d?t:new d("Network error during login","NETWORK_ERROR")}}async logout(){try{this.currentToken&&await fetch(`${this.config.apiBaseUrl}/logout`,{method:"POST",headers:{Authorization:`${this.currentToken.tokenType} ${this.currentToken.accessToken}`,"Content-Type":"application/json"}})}catch(e){console.error("Server logout failed:",e)}finally{this.clearAuth(),this.emitEvent({type:"logout",timestamp:new Date})}}async refreshToken(){var e;if(!((e=this.currentToken)!=null&&e.refreshToken))throw new d("No refresh token available","NO_REFRESH_TOKEN");try{const t=await fetch(`${this.config.apiBaseUrl}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:this.currentToken.refreshToken})}),s=await t.json();if(!t.ok)throw new d(s.message||"Token refresh failed","TOKEN_REFRESH_FAILED",t.status);if(s.token)return this.currentToken=s.token,this.currentUser&&this.storeAuth(this.currentUser,s.token),this.setupAutoRefresh(),this.emitEvent({type:"tokenRefresh",token:s.token,timestamp:new Date}),s.token;throw new d("Invalid refresh response","INVALID_REFRESH_RESPONSE")}catch(t){throw this.clearAuth(),t instanceof d?t:new d("Network error during token refresh","NETWORK_ERROR")}}getConfig(){return this.config}getCurrentUser(){return this.currentUser}getAuthStatus(){return this.authStatus}async validateToken(e){try{return(await fetch(`${this.config.apiBaseUrl}/validate`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}})).ok}catch{return!1}}onAuthStateChange(e){return this.authStateListeners.push(e),e(this.authStatus,this.currentUser||void 0),()=>{const t=this.authStateListeners.indexOf(e);t>-1&&this.authStateListeners.splice(t,1)}}addEventListener(e,t){return this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t),()=>{const s=this.eventListeners.get(e);if(s){const r=s.indexOf(t);r>-1&&s.splice(r,1)}}}setToken(e){const t={accessToken:e,tokenType:"Bearer",expiresAt:new Date(Date.now()+36e5).toISOString()};this.currentToken=t,this.authStatus=E.AUTHENTICATED,localStorage.setItem(this.config.tokenStorageKey,JSON.stringify(t))}getToken(){var e;return((e=this.currentToken)==null?void 0:e.accessToken)||null}clearToken(){this.currentToken=null,this.authStatus=E.UNAUTHENTICATED,localStorage.removeItem(this.config.tokenStorageKey)}setRefreshToken(e){this.currentToken&&(this.currentToken.refreshToken=e,localStorage.setItem(this.config.tokenStorageKey,JSON.stringify(this.currentToken))),localStorage.setItem(this.config.refreshTokenStorageKey,e)}getRefreshToken(){var e;return(e=this.currentToken)!=null&&e.refreshToken?this.currentToken.refreshToken:localStorage.getItem(this.config.refreshTokenStorageKey)}setUser(e){this.currentUser=e,localStorage.setItem(this.config.userStorageKey,JSON.stringify(e))}getUser(){return this.currentUser}clearUser(){this.currentUser=null,localStorage.removeItem(this.config.userStorageKey)}on(e,t){this.addEventListener(e,t)}off(e,t){const s=this.eventListeners.get(e);if(s){const r=s.indexOf(t);r>-1&&s.splice(r,1)}}emit(e,t){this.emitEvent(t)}getCurrentToken(){return this.currentToken}isAuthenticated(){return this.authStatus===E.AUTHENTICATED&&this.currentUser!==null}isTokenExpiringSoon(){if(!this.currentToken)return!1;try{const r=this.currentToken.accessToken;if(r.includes(".")){const i=JSON.parse(atob(r.split(".")[1]));if(i.exp){const n=new Date(i.exp*1e3),o=new Date;return n.getTime()-o.getTime()<=this.config.tokenExpirationBuffer*1e3}}}catch{}const e=new Date(this.currentToken.expiresAt),t=new Date;return e.getTime()-t.getTime()<=this.config.tokenExpirationBuffer*1e3}storeAuth(e,t,s=!1){const r=s?localStorage:sessionStorage;r.setItem(this.config.tokenStorageKey,JSON.stringify(t)),r.setItem(this.config.userStorageKey,JSON.stringify(e)),t.refreshToken&&r.setItem(this.config.refreshTokenStorageKey,t.refreshToken)}clearAuth(){this.currentUser=null,this.currentToken=null,this.authStatus=E.UNAUTHENTICATED,this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),this.clearStoredAuth(),this.notifyAuthStateChange()}clearStoredAuth(){localStorage.removeItem(this.config.tokenStorageKey),localStorage.removeItem(this.config.userStorageKey),localStorage.removeItem(this.config.refreshTokenStorageKey),sessionStorage.removeItem(this.config.tokenStorageKey),sessionStorage.removeItem(this.config.userStorageKey),sessionStorage.removeItem(this.config.refreshTokenStorageKey)}handleAuthError(e){this.emitEvent({type:"authError",error:e,timestamp:new Date}),(e.code==="TOKEN_EXPIRED"||e.code==="TOKEN_INVALID")&&this.clearAuth()}emitEvent(e){const t=this.eventListeners.get(e.type);t&&t.forEach(s=>{try{s(e)}catch(r){console.error("Auth event listener error:",r)}})}notifyAuthStateChange(){this.authStateListeners.forEach(e=>{try{e(this.authStatus,this.currentUser||void 0)}catch(t){console.error("Auth state listener error:",t)}})}destroy(){this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),this.eventListeners.clear(),this.authStateListeners.length=0}}function oe(l){return new ne(l)}const x=oe(),ae=q("auth",()=>{const l=k(null),e=k(""),t=k(!1),s=k(!1),r=O(()=>l.value),i=O(()=>s.value&&!!l.value),n=O(()=>{var f,y;return((f=l.value)==null?void 0:f.username)||((y=l.value)==null?void 0:y.email)||""}),o=async f=>{t.value=!0;try{const y=await x.login(f);return y.success&&y.user&&y.token?(l.value=y.user,e.value=y.token.accessToken,s.value=!0,{success:!0,user:y.user,token:y.token.accessToken}):{success:!1,message:y.message||"登录失败"}}catch(y){return console.error("登录错误:",y),{success:!1,message:y instanceof Error?y.message:"登录失败"}}finally{t.value=!1}},h=async()=>{t.value=!0;try{await x.logout()}catch(f){console.error("登出错误:",f)}finally{l.value=null,e.value="",s.value=!1,t.value=!1}},m=()=>{const f=x.getCurrentUser(),y=x.getToken();f&&y?(l.value=f,e.value=y,s.value=!0):(l.value=null,e.value="",s.value=!1)},c=f=>{l.value&&(l.value={...l.value,...f})};return m(),{user:l,token:e,loading:t,isAuthenticated:s,currentUser:r,isLoggedIn:i,userDisplayName:n,login:o,logout:h,checkAuth:m,updateUser:c}}),le={class:"modal-header"},ce={class:"modal-body"},ue={class:"form-group"},he={key:0,class:"error-text"},de={class:"form-group"},me={key:0,class:"error-text"},fe={class:"form-group"},ge={key:0,class:"error-text"},pe={class:"form-group"},ye={key:0,class:"error-text"},we={class:"form-actions"},Ae=["disabled"],Ee=K({__name:"RegisterModal",emits:["close","success"],setup(l,{emit:e}){const t=e,s=k(!1),r=I({username:"",email:"",password:"",confirmPassword:""}),i=I({username:"",email:"",password:"",confirmPassword:""}),n=()=>{Object.keys(i).forEach(c=>{i[c]=""});let m=!0;return r.username.trim()?r.username.length<3&&(i.username="用户名至少3个字符",m=!1):(i.username="请输入用户名",m=!1),r.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.email)||(i.email="请输入有效的邮箱地址",m=!1):(i.email="请输入邮箱地址",m=!1),r.password?r.password.length<6&&(i.password="密码至少6个字符",m=!1):(i.password="请输入密码",m=!1),r.confirmPassword?r.password!==r.confirmPassword&&(i.confirmPassword="两次输入的密码不一致",m=!1):(i.confirmPassword="请确认密码",m=!1),m},o=async()=>{if(n()){s.value=!0;try{await new Promise(c=>setTimeout(c,1e3));const m={id:Date.now(),username:r.username,email:r.email};t("success",m)}catch(m){console.error("注册失败:",m)}finally{s.value=!1}}},h=()=>{t("close")};return(m,c)=>(T(),S("div",{class:"register-modal-overlay",onClick:h},[a("div",{class:"register-modal",onClick:c[6]||(c[6]=H(()=>{},["stop"]))},[a("div",le,[c[7]||(c[7]=a("h3",null,"用户注册",-1)),a("button",{class:"close-btn",onClick:c[0]||(c[0]=f=>m.$emit("close"))},[b(U(R),{name:"close"})])]),a("div",ce,[a("form",{onSubmit:H(o,["prevent"])},[a("div",ue,[c[8]||(c[8]=a("label",{for:"username"},"用户名",-1)),P(a("input",{id:"username","onUpdate:modelValue":c[1]||(c[1]=f=>r.username=f),type:"text",class:L(["form-input",{error:i.username}]),placeholder:"请输入用户名",required:""},null,2),[[_,r.username]]),i.username?(T(),S("span",he,v(i.username),1)):C("",!0)]),a("div",de,[c[9]||(c[9]=a("label",{for:"email"},"邮箱",-1)),P(a("input",{id:"email","onUpdate:modelValue":c[2]||(c[2]=f=>r.email=f),type:"email",class:L(["form-input",{error:i.email}]),placeholder:"请输入邮箱地址",required:""},null,2),[[_,r.email]]),i.email?(T(),S("span",me,v(i.email),1)):C("",!0)]),a("div",fe,[c[10]||(c[10]=a("label",{for:"password"},"密码",-1)),P(a("input",{id:"password","onUpdate:modelValue":c[3]||(c[3]=f=>r.password=f),type:"password",class:L(["form-input",{error:i.password}]),placeholder:"请输入密码",required:""},null,2),[[_,r.password]]),i.password?(T(),S("span",ge,v(i.password),1)):C("",!0)]),a("div",pe,[c[11]||(c[11]=a("label",{for:"confirmPassword"},"确认密码",-1)),P(a("input",{id:"confirmPassword","onUpdate:modelValue":c[4]||(c[4]=f=>r.confirmPassword=f),type:"password",class:L(["form-input",{error:i.confirmPassword}]),placeholder:"请再次输入密码",required:""},null,2),[[_,r.confirmPassword]]),i.confirmPassword?(T(),S("span",ye,v(i.confirmPassword),1)):C("",!0)]),a("div",we,[a("button",{type:"button",class:"btn btn-secondary",onClick:c[5]||(c[5]=f=>m.$emit("close"))}," 取消 "),a("button",{type:"submit",class:"btn btn-primary",disabled:s.value},v(s.value?"注册中...":"注册"),9,Ae)])],32)])])]))}}),Te=V(Ee,[["__scopeId","data-v-3d9d473c"]]),Se={class:"login-container"},Ce={class:"login-card"},ve={class:"login-header"},ke={class:"logo"},Ue={class:"form-group"},Re={key:0,class:"error-message"},Pe={class:"form-group"},be={class:"password-input"},Le=["type"],Ne={key:0,class:"error-message"},_e={class:"form-options"},Be={class:"checkbox-label"},De=["disabled"],xe={key:0,class:"login-error"},Ie={class:"social-login"},Oe={class:"social-button github"},He={class:"social-button google"},Me={class:"register-link"},$e=K({__name:"Login",setup(l){const e=G(),t=ae(),s=k(!1),r=k(!1),i=k(!1),n=k(null),o=I({username:"",password:"",rememberMe:!1}),h=I({username:"",password:""}),m=()=>(h.username="",h.password="",o.username.trim()?o.username.length<3?(h.username="用户名至少3个字符",!1):o.password?o.password.length<6?(h.password="密码至少6个字符",!1):!0:(h.password="请输入密码",!1):(h.username="请输入用户名",!1)),c=async()=>{if(m())try{s.value=!0,n.value=null,await t.login({username:o.username,password:o.password,rememberMe:o.rememberMe}),e.push("/designer")}catch(w){n.value=w instanceof Error?w.message:"登录失败，请重试"}finally{s.value=!1}},f=()=>{r.value=!r.value},y=w=>{i.value=!1,o.username=w.username};return(w,u)=>(T(),S("div",Se,[a("div",Ce,[a("div",ve,[a("div",ke,[b(U(R),{name:"logo",class:"logo-icon"})]),u[5]||(u[5]=a("h1",{class:"login-title"},"低代码平台",-1)),u[6]||(u[6]=a("p",{class:"login-subtitle"},"欢迎回来，请登录您的账户",-1))]),a("form",{onSubmit:H(c,["prevent"]),class:"login-form"},[a("div",Ue,[u[7]||(u[7]=a("label",{for:"username",class:"form-label"},"用户名",-1)),P(a("input",{id:"username","onUpdate:modelValue":u[0]||(u[0]=p=>o.username=p),type:"text",class:L(["form-input",{error:h.username}]),placeholder:"请输入用户名",autocomplete:"username"},null,2),[[_,o.username]]),h.username?(T(),S("span",Re,v(h.username),1)):C("",!0)]),a("div",Pe,[u[8]||(u[8]=a("label",{for:"password",class:"form-label"},"密码",-1)),a("div",be,[P(a("input",{id:"password","onUpdate:modelValue":u[1]||(u[1]=p=>o.password=p),type:r.value?"text":"password",class:L(["form-input",{error:h.password}]),placeholder:"请输入密码",autocomplete:"current-password"},null,10,Le),[[j,o.password]]),a("button",{type:"button",onClick:f,class:"password-toggle"},[b(U(R),{name:r.value?"eye-off":"eye"},null,8,["name"])])]),h.password?(T(),S("span",Ne,v(h.password),1)):C("",!0)]),a("div",_e,[a("label",Be,[P(a("input",{"onUpdate:modelValue":u[2]||(u[2]=p=>o.rememberMe=p),type:"checkbox",class:"checkbox"},null,512),[[J,o.rememberMe]]),u[9]||(u[9]=a("span",{class:"checkbox-text"},"记住我",-1))]),u[10]||(u[10]=a("a",{href:"#",class:"forgot-password"},"忘记密码？",-1))]),a("button",{type:"submit",class:"login-button",disabled:s.value},[s.value?(T(),$(U(R),{key:0,name:"loading",class:"loading-icon"})):C("",!0),D(" "+v(s.value?"登录中...":"登录"),1)],8,De),n.value?(T(),S("div",xe,[b(U(R),{name:"alert-circle",class:"error-icon"}),D(" "+v(n.value),1)])):C("",!0)],32),u[14]||(u[14]=a("div",{class:"login-divider"},[a("span",null,"或者")],-1)),a("div",Ie,[a("button",Oe,[b(U(R),{name:"github"}),u[11]||(u[11]=D(" GitHub "))]),a("button",He,[b(U(R),{name:"google"}),u[12]||(u[12]=D(" Google "))])]),a("div",Me,[u[13]||(u[13]=a("span",null,"还没有账户？",-1)),a("a",{href:"#",onClick:u[3]||(u[3]=p=>i.value=!0)},"立即注册")])]),i.value?(T(),$(Te,{key:0,onClose:u[4]||(u[4]=p=>i.value=!1),onSuccess:y})):C("",!0)]))}}),je=V($e,[["__scopeId","data-v-957bc865"]]);export{je as default};
